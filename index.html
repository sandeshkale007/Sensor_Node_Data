<script>
    const fetchData = async () => {
        try {
            const response = await fetch("https://eu1.cloud.thethings.network/api/v3/as/applications/lora-20245/packages/storage/uplink_message", {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer NNSXS.GWOIHRXZFTMMBAZIZDGQ26RMPNU6UGJTPIZU5QY.ZDGZRNEJQQGPP2WCCJCR3XNIHDGVY776O3VZ5JAFWBZ7TTCPYYGA',
                    'Accept': 'application/json'
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP Error: ${response.status} ${response.statusText}`);
            }

            // Get the raw response as text since itâ€™s multiple JSON objects
            const rawData = await response.text();
            console.log('Raw API Response:', rawData);

            // Split the raw response into individual JSON objects
            const jsonObjects = rawData
                .split('\n') // TTN sends JSON objects separated by newlines
                .filter(line => line.trim() !== ''); // Remove empty lines

            // Parse and process each JSON object
            const dataArray = jsonObjects.map(json => JSON.parse(json));

            // Display the parsed data
            displayData(dataArray);
        } catch (error) {
            console.error('Error:', error);
            document.getElementById('data-container').innerHTML = `<p style="color: red;">Failed to load data: ${error.message}</p>`;
        }
    };

    // Function to display parsed data
    const displayData = (dataArray) => {
        const container = document.getElementById('data-container');
        container.innerHTML = ''; // Clear previous content

        dataArray.forEach((data, index) => {
            // Extract decoded payload from each message
            const payload = data.result.uplink_message.decoded_payload;

            // Create a block for each payload
            const block = document.createElement('div');
            block.classList.add('data-block');
            block.style.margin = '10px 0';
            block.style.padding = '10px';
            block.style.border = '1px solid #ccc';
            block.style.borderRadius = '5px';
            block.style.backgroundColor = '#f9f9f9';
            block.innerHTML = `
                <h3>Message #${index + 1}</h3>
                <pre>${JSON.stringify(payload, null, 4)}</pre>
            `;
            container.appendChild(block);
        });
    };

    // Fetch data on page load
    fetchData();
</script>
